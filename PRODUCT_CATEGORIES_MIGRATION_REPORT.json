{
  "timestamp": "2025-11-22T02:41:05.389Z",
  "database": "vdt",
  "migrationFile": "./database/migrations/create_product_categories_junction.sql",
  "totalStatements": 16,
  "successful": 0,
  "failed": 16,
  "errors": [
    {
      "statement": "-- ============================================\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- ============================================\r\n-- MIGRATION: Product Categories Junction Table\r\n-- Date: 2025-11-22\r\n-- Purpose: Enable many-to-many relationship between products and categories\r\n-- Database: vdt (remote)\r\n-- ============================================\r\n\r\n-- PH√ÇN T√çCH C·∫§U TR√öC HI·ªÜN T·∫†I:\r\n-- \r\n-- B·∫£ng products:\r\n--   - id (INTEGER, PK)\r\n--   - name (TEXT, NOT NULL)\r\n--   - category_id (INTEGER) - Quan h·ªá 1-nhi·ªÅu hi·ªán t·∫°i\r\n--   - price, cost_price, original_price (REAL)\r\n--   - sku, description, image_url (TEXT)\r\n--   - rating (REAL), purchases, stock_quantity (INTEGER)\r\n--   - is_active (INTEGER), created_at, updated_at (TEXT)\r\n--\r\n-- B·∫£ng categories:\r\n--   - id (INTEGER, PK)\r\n--   - name (TEXT, NOT NULL, UNIQUE)\r\n--   - description, icon, color (TEXT)\r\n--   - display_order (INTEGER)\r\n--   - is_active (INTEGER), created_at, updated_at (TEXT)\r\n--\r\n-- V·∫§N ƒê·ªÄ: \r\n--   Hi·ªán t·∫°i products.category_id ch·ªâ cho ph√©p 1 s·∫£n ph·∫©m thu·ªôc 1 danh m·ª•c\r\n--   C·∫ßn: 1 s·∫£n ph·∫©m c√≥ th·ªÉ thu·ªôc nhi·ªÅu danh m·ª•c (many-to-many)\r\n--\r\n-- GI·∫¢I PH√ÅP:\r\n--   T·∫°o b·∫£ng trung gian product_categories v·ªõi c√°c t√≠nh nƒÉng:\r\n--   ‚úÖ Quan h·ªá many-to-many\r\n--   ‚úÖ Primary category support (danh m·ª•c ch√≠nh ƒë·ªÉ hi·ªÉn th·ªã)\r\n--   ‚úÖ Display order cho m·ªói category trong product\r\n--   ‚úÖ Cascade delete ƒë·ªÉ ƒë·∫£m b·∫£o data integrity\r\n--   ‚úÖ Indexes t·ªëi ∆∞u cho query performance\r\n--   ‚úÖ Migration data t·ª´ category_id c≈©\r\n-- ============================================\r\n\r\n-- Step 1: Create junction table\r\nCREATE TABLE IF NOT EXISTS product_categories (\r\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n  product_id INTEGER NOT NULL,\r\n  category_id INTEGER NOT NULL,\r\n  \r\n  -- ƒê√°nh d·∫•u danh m·ª•c ch√≠nh (hi·ªÉn th·ªã ƒë·∫ßu ti√™n)\r\n  is_primary INTEGER DEFAULT 0,\r\n  \r\n  -- Th·ª© t·ª± hi·ªÉn th·ªã c·ªßa category trong product (optional)\r\n  display_order INTEGER DEFAULT 0,\r\n  \r\n  -- Metadata\r\n  created_at TEXT DEFAULT CURRENT_TIMESTAMP,\r\n  \r\n  -- Foreign keys v·ªõi CASCADE DELETE\r\n  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,\r\n  FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE,\r\n  \r\n  -- ƒê·∫£m b·∫£o kh√¥ng c√≥ duplicate (product + category)\r\n  UNIQUE(product_id, category_id)\r\n)\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument: \" \"\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-37_608.log\"\n"
    },
    {
      "statement": "-- Step 2: Create indexes for optimal query performance\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Step 2: Create indexes for optimal query performance\r\n-- Index cho query: \\\"L·∫•y t·∫•t c·∫£ categories c·ªßa 1 product\\\"\r\nCREATE INDEX IF NOT EXISTS idx_product_categories_product \r\nON product_categories(product_id)\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Step 2: Create indexes for optimal query performance\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-39_374.log\"\n"
    },
    {
      "statement": "-- Index cho query: \"L·∫•y t·∫•t c·∫£ products trong 1 category\"\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Index cho query: \\\"L·∫•y t·∫•t c·∫£ products trong 1 category\\\"\r\nCREATE INDEX IF NOT EXISTS idx_product_categories_category \r\nON product_categories(category_id)\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Index cho query: \"L·∫•y t·∫•t c·∫£ products trong 1 category\"\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-40_782.log\"\n"
    },
    {
      "statement": "-- Index cho query: \"L·∫•y primary category c·ªßa products\"\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Index cho query: \\\"L·∫•y primary category c·ªßa products\\\"\r\nCREATE INDEX IF NOT EXISTS idx_product_categories_primary \r\nON product_categories(product_id, is_primary)\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Index cho query: \"L·∫•y primary category c·ªßa products\"\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-42_166.log\"\n"
    },
    {
      "statement": "-- Composite index cho sorting\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Composite index cho sorting\r\nCREATE INDEX IF NOT EXISTS idx_product_categories_display \r\nON product_categories(product_id, display_order)\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Composite index cho sorting\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-43_562.log\"\n"
    },
    {
      "statement": "-- Step 3: Migrate existing data from products.category_id\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Step 3: Migrate existing data from products.category_id\r\n-- Chuy·ªÉn d·ªØ li·ªáu c≈© sang b·∫£ng m·ªõi, ƒë√°nh d·∫•u l√† primary category\r\nINSERT INTO product_categories (product_id, category_id, is_primary, display_order)\r\nSELECT \r\n    id as product_id, \r\n    category_id, \r\n    1 as is_primary,  -- ƒê√°nh d·∫•u l√† danh m·ª•c ch√≠nh\r\n    0 as display_order\r\nFROM products \r\nWHERE category_id IS NOT NULL \r\n  AND category_id != ''\r\n  AND category_id > 0\r\n  -- Ch·ªâ migrate n·∫øu category t·ªìn t·∫°i\r\n  AND category_id IN (SELECT id FROM categories)\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Step 3: Migrate existing data from products\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-44_926.log\"\n"
    },
    {
      "statement": "-- Step 4: Create trigger to ensure only one primary category per product\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Step 4: Create trigger to ensure only one primary category per product\r\nCREATE TRIGGER IF NOT EXISTS ensure_single_primary_category\r\nBEFORE INSERT ON product_categories\r\nWHEN NEW.is_primary = 1\r\nBEGIN\r\n  -- N·∫øu insert primary category m·ªõi, b·ªè primary c·ªßa c√°c category c≈©\r\n  UPDATE product_categories \r\n  SET is_primary = 0 \r\n  WHERE product_id = NEW.product_id \r\n    AND is_primary = 1\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Step 4: Create trigger to ensure only one primary category per product\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-46_313.log\"\n"
    },
    {
      "statement": "END",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"END\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mA request to the Cloudflare API (/accounts/6732e495e6dc332a4d51e0aba6c0408a/d1/database/19917e57-ced3-4fc3-adad-368a2e989ea7/query) failed.\u001b[0m\n\n  To execute a transaction, please use the state.storage.transaction() or state.storage.transactionSync() APIs instead of the SQL BEGIN TRANSACTION or SAVEPOINT statements. The JavaScript API is safer because it will automatically roll back on exceptions, and because it interacts correctly with Durable Objects' automatic atomic write coalescing. [code: 7500]\n  \n  If you think this is a bug, please open an issue at: \u001b[4mhttps://github.com/cloudflare/workers-sdk/issues/new/choose\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-47_684.log\"\n"
    },
    {
      "statement": "-- Trigger t∆∞∆°ng t·ª± cho UPDATE\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Trigger t∆∞∆°ng t·ª± cho UPDATE\r\nCREATE TRIGGER IF NOT EXISTS ensure_single_primary_category_update\r\nBEFORE UPDATE ON product_categories\r\nWHEN NEW.is_primary = 1 AND OLD.is_primary = 0\r\nBEGIN\r\n  UPDATE product_categories \r\n  SET is_primary = 0 \r\n  WHERE product_id = NEW.product_id \r\n    AND id != NEW.id\r\n    AND is_primary = 1\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Trigger t∆∞∆°ng t·ª± cho UPDATE\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-51_984.log\"\n"
    },
    {
      "statement": "END",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"END\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mA request to the Cloudflare API (/accounts/6732e495e6dc332a4d51e0aba6c0408a/d1/database/19917e57-ced3-4fc3-adad-368a2e989ea7/query) failed.\u001b[0m\n\n  To execute a transaction, please use the state.storage.transaction() or state.storage.transactionSync() APIs instead of the SQL BEGIN TRANSACTION or SAVEPOINT statements. The JavaScript API is safer because it will automatically roll back on exceptions, and because it interacts correctly with Durable Objects' automatic atomic write coalescing. [code: 7500]\n  \n  If you think this is a bug, please open an issue at: \u001b[4mhttps://github.com/cloudflare/workers-sdk/issues/new/choose\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-53_427.log\"\n"
    },
    {
      "statement": "-- ============================================\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- ============================================\r\n-- BACKWARD COMPATIBILITY\r\n-- ============================================\r\n-- GI·ªÆ L·∫†I column products.category_id ƒë·ªÉ:\r\n-- 1. Backward compatibility v·ªõi code c≈©\r\n-- 2. D√πng l√†m \\\"primary category\\\" reference nhanh\r\n-- 3. Tr√°nh breaking changes\r\n--\r\n-- T·∫°o trigger ƒë·ªÉ t·ª± ƒë·ªông sync category_id v·ªõi primary category\r\nCREATE TRIGGER IF NOT EXISTS sync_primary_category_to_products\r\nAFTER INSERT ON product_categories\r\nWHEN NEW.is_primary = 1\r\nBEGIN\r\n  UPDATE products \r\n  SET category_id = NEW.category_id,\r\n      updated_at = CURRENT_TIMESTAMP\r\n  WHERE id = NEW.product_id\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument: \" \"\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-55_087.log\"\n"
    },
    {
      "statement": "END",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"END\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mA request to the Cloudflare API (/accounts/6732e495e6dc332a4d51e0aba6c0408a/d1/database/19917e57-ced3-4fc3-adad-368a2e989ea7/query) failed.\u001b[0m\n\n  To execute a transaction, please use the state.storage.transaction() or state.storage.transactionSync() APIs instead of the SQL BEGIN TRANSACTION or SAVEPOINT statements. The JavaScript API is safer because it will automatically roll back on exceptions, and because it interacts correctly with Durable Objects' automatic atomic write coalescing. [code: 7500]\n  \n  If you think this is a bug, please open an issue at: \u001b[4mhttps://github.com/cloudflare/workers-sdk/issues/new/choose\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-56_486.log\"\n"
    },
    {
      "statement": "CREATE TRIGGER IF NOT EXISTS sync_primary_category_update\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"CREATE TRIGGER IF NOT EXISTS sync_primary_category_update\r\nAFTER UPDATE ON product_categories\r\nWHEN NEW.is_primary = 1\r\nBEGIN\r\n  UPDATE products \r\n  SET category_id = NEW.category_id,\r\n      updated_at = CURRENT_TIMESTAMP\r\n  WHERE id = NEW.product_id\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mA request to the Cloudflare API (/accounts/6732e495e6dc332a4d51e0aba6c0408a/d1/database/19917e57-ced3-4fc3-adad-368a2e989ea7/query) failed.\u001b[0m\n\n  incomplete input: SQLITE_ERROR [code: 7500]\n  \n  If you think this is a bug, please open an issue at: \u001b[4mhttps://github.com/cloudflare/workers-sdk/issues/new/choose\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-58_197.log\"\n"
    },
    {
      "statement": "END",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"END\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mA request to the Cloudflare API (/accounts/6732e495e6dc332a4d51e0aba6c0408a/d1/database/19917e57-ced3-4fc3-adad-368a2e989ea7/query) failed.\u001b[0m\n\n  To execute a transaction, please use the state.storage.transaction() or state.storage.transactionSync() APIs instead of the SQL BEGIN TRANSACTION or SAVEPOINT statements. The JavaScript API is safer because it will automatically roll back on exceptions, and because it interacts correctly with Durable Objects' automatic atomic write coalescing. [code: 7500]\n  \n  If you think this is a bug, please open an issue at: \u001b[4mhttps://github.com/cloudflare/workers-sdk/issues/new/choose\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-40-59_807.log\"\n"
    },
    {
      "statement": "-- Trigger khi x√≥a primary category\r",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"-- Trigger khi x√≥a primary category\r\nCREATE TRIGGER IF NOT EXISTS handle_primary_category_delete\r\nAFTER DELETE ON product_categories\r\nWHEN OLD.is_primary = 1\r\nBEGIN\r\n  -- T√¨m category kh√°c ƒë·ªÉ l√†m primary (n·∫øu c√≥)\r\n  UPDATE products \r\n  SET category_id = (\r\n    SELECT category_id \r\n    FROM product_categories \r\n    WHERE product_id = OLD.product_id \r\n    ORDER BY display_order ASC \r\n    LIMIT 1\r\n  ),\r\n  updated_at = CURRENT_TIMESTAMP\r\n  WHERE id = OLD.product_id\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mUnknown argument:  Trigger khi x√≥a primary category\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-41-01_529.log\"\n"
    },
    {
      "statement": "END",
      "error": "Command failed: wrangler d1 execute vdt --remote --command \"END\"\n\u001b[31mX \u001b[41;31m[\u001b[41;97mERROR\u001b[41;31m]\u001b[0m \u001b[1mA request to the Cloudflare API (/accounts/6732e495e6dc332a4d51e0aba6c0408a/d1/database/19917e57-ced3-4fc3-adad-368a2e989ea7/query) failed.\u001b[0m\n\n  To execute a transaction, please use the state.storage.transaction() or state.storage.transactionSync() APIs instead of the SQL BEGIN TRANSACTION or SAVEPOINT statements. The JavaScript API is safer because it will automatically roll back on exceptions, and because it interacts correctly with Durable Objects' automatic atomic write coalescing. [code: 7500]\n  \n  If you think this is a bug, please open an issue at: \u001b[4mhttps://github.com/cloudflare/workers-sdk/issues/new/choose\u001b[0m\n\n\nü™µ  Logs were written to \"C:\\Users\\Admin\\AppData\\Roaming\\xdg.config\\.wrangler\\logs\\wrangler-2025-11-22_02-41-02_925.log\"\n"
    }
  ]
}