// Google Apps Script code to handle form submissions
// Deploy this as a Web App in Google Apps Script

function doPost(e) {
  try {
    // Parse the incoming data
    const data = JSON.parse(e.postData.contents);
    
    // Get or create the spreadsheet
    const spreadsheetId = '1QOXBlIcX1Th1ZnNKulnbxEJDD-HfAiKfOFKHn2pBo4o';
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    
    // Get or create the sheet (s·ª≠ d·ª•ng t√™n sheet "DS REF" nh∆∞ b·∫°n ƒë√£ t·∫°o)
    let sheet = spreadsheet.getSheetByName('DS REF');
    if (!sheet) {
      sheet = spreadsheet.insertSheet('DS REF');
      
      // Add headers if it's a new sheet
      const headers = [
        'Th·ªùi Gian',
        'H·ªç T√™n',
        'S·ªë ƒêi·ªán Tho·∫°i',
        'Email',
        'T·ªânh/Th√†nh',
        'Tu·ªïi',
        'Kinh Nghi·ªám',
        'Facebook',
        'L√Ω Do',
        'Tr·∫°ng Th√°i'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // Format headers
      const headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setBackground('#f8b4cb');
      headerRange.setFontWeight('bold');
      headerRange.setFontColor('white');
    }
    
    // Prepare the row data
    const rowData = [
      data.timestamp || new Date().toLocaleString('vi-VN'),
      data.fullName || '',
      data.phone || '',
      data.email || '',
      data.city || '',
      data.age || '',
      data.experience || '',
      data.facebook || '',
      data.motivation || '',
      'M·ªõi' // Status
    ];
    
    // Add the data to the sheet
    sheet.appendRow(rowData);
    
    // Auto-resize columns
    sheet.autoResizeColumns(1, rowData.length);
    
    // Send notification email (optional)
    sendNotificationEmail(data);
    
    // Return success response
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'Data saved successfully'
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('Error:', error);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function sendNotificationEmail(data) {
  try {
    const emailAddress = 'your-email@gmail.com'; // Thay b·∫±ng email c·ªßa b·∫°n ƒë·ªÉ nh·∫≠n th√¥ng b√°o
    const subject = 'üéâ ƒêƒÉng K√Ω C·ªông T√°c Vi√™n M·ªõi';
    
    const htmlBody = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #f8b4cb, #d4a5d4); padding: 20px; border-radius: 10px 10px 0 0;">
          <h2 style="color: white; margin: 0;">ƒêƒÉng K√Ω C·ªông T√°c Vi√™n M·ªõi</h2>
        </div>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 0 0 10px 10px;">
          <h3 style="color: #333; margin-top: 0;">Th√¥ng Tin Ng∆∞·ªùi ƒêƒÉng K√Ω:</h3>
          
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">H·ªç T√™n:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.fullName}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">S·ªë ƒêi·ªán Tho·∫°i:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.phone}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Email:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.email}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">T·ªânh/Th√†nh:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.city}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Tu·ªïi:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.age || 'Kh√¥ng cung c·∫•p'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Kinh Nghi·ªám:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.experience || 'Kh√¥ng cung c·∫•p'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">Facebook:</td>
              <td style="padding: 8px; border-bottom: 1px solid #ddd;">${data.facebook || 'Kh√¥ng cung c·∫•p'}</td>
            </tr>
          </table>
          
          ${data.motivation ? `
            <h4 style="color: #333; margin-top: 20px;">L√Ω Do Tham Gia:</h4>
            <p style="background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #f8b4cb;">
              ${data.motivation}
            </p>
          ` : ''}
          
          <p style="margin-top: 20px; color: #666; font-size: 14px;">
            Th·ªùi gian ƒëƒÉng k√Ω: ${data.timestamp || new Date().toLocaleString('vi-VN')}
          </p>
        </div>
      </div>
    `;
    
    MailApp.sendEmail({
      to: emailAddress,
      subject: subject,
      htmlBody: htmlBody
    });
    
  } catch (error) {
    console.error('Email notification error:', error);
  }
}

// Test function to verify the setup
function testFunction() {
  const testData = {
    fullName: 'Nguy·ªÖn Th·ªã Test',
    phone: '0901234567',
    email: 'test@example.com',
    city: 'H√† N·ªôi',
    age: '26-30',
    experience: 'M·ªõi b·∫Øt ƒë·∫ßu',
    facebook: 'https://facebook.com/test',
    motivation: 'Mu·ªën c√≥ th√™m thu nh·∫≠p',
    timestamp: new Date().toLocaleString('vi-VN')
  };
  
  // Simulate a POST request
  const mockEvent = {
    postData: {
      contents: JSON.stringify(testData)
    }
  };
  
  const result = doPost(mockEvent);
  console.log('Test result:', result.getContent());
}