<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Abbreviation Fix - Smart Paste</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-case {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-case h3 {
            margin-top: 0;
            color: #34495e;
        }
        .input {
            background: #fff;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
        }
        .result.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .result.fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .result.partial {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .detail {
            margin: 5px 0;
            padding: 5px 10px;
            background: white;
            border-radius: 3px;
        }
        .label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 120px;
        }
        .value {
            color: #2c3e50;
        }
        .confidence {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .confidence.high {
            background: #28a745;
            color: white;
        }
        .confidence.medium {
            background: #ffc107;
            color: #333;
        }
        .confidence.low {
            background: #dc3545;
            color: white;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #2980b9;
        }
        .console-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .console-log pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Abbreviation Fix - Smart Paste</h1>
        <p>Test c√°c ƒë·ªãa ch·ªâ c√≥ vi·∫øt t·∫Øt ƒë·∫∑c bi·ªát (P. 22, Q. B/Th·∫°nh...)</p>
        
        <button onclick="runAllTests()">‚ñ∂Ô∏è Ch·∫°y t·∫•t c·∫£ test</button>
        <button onclick="clearResults()">üóëÔ∏è X√≥a k·∫øt qu·∫£</button>
        
        <div id="results"></div>
    </div>

    <!-- Load dependencies -->
    <script src="/assets/js/address-selector.js"></script>
    <script src="/assets/js/orders/orders-smart-paste.js"></script>

    <script>
        // Test cases
        const testCases = [
            {
                name: "Test 1: P. 22., Q. B/Th·∫°nh (Original failing case)",
                input: "135/17/43 Nguy·ªÖn H·ªØu C·∫£nh, P. 22., Q. B/Th·∫°nh",
                expected: {
                    province: "Th√†nh ph·ªë H·ªì Ch√≠ Minh",
                    district: "Qu·∫≠n B√¨nh Th·∫°nh",
                    ward: "Ph∆∞·ªùng 22",
                    street: "135/17/43 Nguy·ªÖn H·ªØu C·∫£nh"
                }
            },
            {
                name: "Test 2: P.22, Q.B√¨nh Th·∫°nh (No space)",
                input: "135/17/43 Nguy·ªÖn H·ªØu C·∫£nh, P.22, Q.B√¨nh Th·∫°nh",
                expected: {
                    province: "Th√†nh ph·ªë H·ªì Ch√≠ Minh",
                    district: "Qu·∫≠n B√¨nh Th·∫°nh",
                    ward: "Ph∆∞·ªùng 22",
                    street: "135/17/43 Nguy·ªÖn H·ªØu C·∫£nh"
                }
            },
            {
                name: "Test 3: F. 17, Q. G√≤ V·∫•p (Another district)",
                input: "123 Quang Trung, F. 17, Q. G/V·∫•p",
                expected: {
                    province: "Th√†nh ph·ªë H·ªì Ch√≠ Minh",
                    district: "Qu·∫≠n G√≤ V·∫•p",
                    ward: "Ph∆∞·ªùng 17",
                    street: "123 Quang Trung"
                }
            },
            {
                name: "Test 4: Normal address (should not break)",
                input: "Ph∆∞·ªùng 14, Qu·∫≠n 10, TP.HCM",
                expected: {
                    province: "Th√†nh ph·ªë H·ªì Ch√≠ Minh",
                    district: "Qu·∫≠n 10",
                    ward: "Ph∆∞·ªùng 14",
                    street: ""
                }
            },
            {
                name: "Test 5: H√† N·ªôi address (should not be affected)",
                input: "X√£ ƒê√¥ng Cao, Huy·ªán ƒê√¥ng Anh, H√† N·ªôi",
                expected: {
                    province: "Th√†nh ph·ªë H√† N·ªôi",
                    district: "Huy·ªán ƒê√¥ng Anh",
                    ward: "X√£ ƒê√¥ng Cao",
                    street: ""
                }
            },
            {
                name: "Test 6: Q. T√¢n B√¨nh (Another abbreviation)",
                input: "456 L·∫°c Long Qu√¢n, P. 5, Q. T/B√¨nh",
                expected: {
                    province: "Th√†nh ph·ªë H·ªì Ch√≠ Minh",
                    district: "Qu·∫≠n T√¢n B√¨nh",
                    ward: "Ph∆∞·ªùng 5",
                    street: "456 L·∫°c Long Qu√¢n"
                }
            },
            {
                name: "Test 7: Mixed format",
                input: "789/12 CMT8, P. 15., Qu·∫≠n 10, TPHCM",
                expected: {
                    province: "Th√†nh ph·ªë H·ªì Ch√≠ Minh",
                    district: "Qu·∫≠n 10",
                    ward: "Ph∆∞·ªùng 15",
                    street: "789/12 CMT8"
                }
            }
        ];

        async function runAllTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>‚è≥ ƒêang ch·∫°y tests...</p>';

            // Wait for address data to load
            if (!window.addressSelector || !window.addressSelector.loaded) {
                await window.addressSelector.loadData();
            }

            let passCount = 0;
            let failCount = 0;
            let partialCount = 0;

            for (const testCase of testCases) {
                const result = await runTest(testCase);
                
                if (result.status === 'success') passCount++;
                else if (result.status === 'fail') failCount++;
                else partialCount++;
            }

            // Add summary
            const summary = document.createElement('div');
            summary.style.cssText = 'margin: 20px 0; padding: 20px; background: #e8f4f8; border-radius: 8px; font-size: 18px;';
            summary.innerHTML = `
                <strong>üìä T·ªïng k·∫øt:</strong><br>
                ‚úÖ Pass: ${passCount}/${testCases.length}<br>
                ‚ö†Ô∏è Partial: ${partialCount}/${testCases.length}<br>
                ‚ùå Fail: ${failCount}/${testCases.length}<br>
                <strong>Success Rate: ${Math.round((passCount / testCases.length) * 100)}%</strong>
            `;
            resultsDiv.insertBefore(summary, resultsDiv.firstChild);
        }

        async function runTest(testCase) {
            const resultsDiv = document.getElementById('results');
            const testDiv = document.createElement('div');
            testDiv.className = 'test-case';

            // Capture console logs
            const logs = [];
            const originalLog = console.log;
            console.log = function(...args) {
                logs.push(args.join(' '));
                originalLog.apply(console, args);
            };

            try {
                // Run smart paste
                const parsed = await smartParseCustomerInfo(testCase.input);

                // Restore console.log
                console.log = originalLog;

                // Check results
                const checks = {
                    province: parsed.data.address.province?.Name === testCase.expected.province,
                    district: parsed.data.address.district?.Name === testCase.expected.district,
                    ward: parsed.data.address.ward?.Name === testCase.expected.ward,
                    street: testCase.expected.street ? parsed.data.address.street?.includes(testCase.expected.street) : true
                };

                const passCount = Object.values(checks).filter(v => v).length;
                const totalChecks = Object.keys(checks).length;
                
                let status = 'fail';
                if (passCount === totalChecks) status = 'success';
                else if (passCount > 0) status = 'partial';

                // Build result HTML
                testDiv.innerHTML = `
                    <h3>${testCase.name}</h3>
                    <div class="input">üìù Input: ${testCase.input}</div>
                    <div class="result ${status}">
                        <strong>${status === 'success' ? '‚úÖ PASS' : status === 'partial' ? '‚ö†Ô∏è PARTIAL' : '‚ùå FAIL'}</strong>
                        <span class="confidence ${parsed.data.address.confidence}">${parsed.data.address.confidence}</span>
                        <div class="detail">
                            <span class="label">T·ªânh/TP:</span>
                            <span class="value">${parsed.data.address.province?.Name || '‚ùå Kh√¥ng t√¨m th·∫•y'}</span>
                            ${checks.province ? '‚úÖ' : '‚ùå Expected: ' + testCase.expected.province}
                        </div>
                        <div class="detail">
                            <span class="label">Qu·∫≠n/Huy·ªán:</span>
                            <span class="value">${parsed.data.address.district?.Name || '‚ùå Kh√¥ng t√¨m th·∫•y'}</span>
                            ${checks.district ? '‚úÖ' : '‚ùå Expected: ' + testCase.expected.district}
                        </div>
                        <div class="detail">
                            <span class="label">Ph∆∞·ªùng/X√£:</span>
                            <span class="value">${parsed.data.address.ward?.Name || '‚ùå Kh√¥ng t√¨m th·∫•y'}</span>
                            ${checks.ward ? '‚úÖ' : '‚ùå Expected: ' + testCase.expected.ward}
                        </div>
                        <div class="detail">
                            <span class="label">ƒê·ªãa ch·ªâ:</span>
                            <span class="value">${parsed.data.address.street || '(tr·ªëng)'}</span>
                            ${checks.street ? '‚úÖ' : '‚ö†Ô∏è'}
                        </div>
                    </div>
                    <details>
                        <summary style="cursor: pointer; margin-top: 10px; color: #666;">üìã Console logs (click to expand)</summary>
                        <div class="console-log">
                            <pre>${logs.join('\n')}</pre>
                        </div>
                    </details>
                `;

                resultsDiv.appendChild(testDiv);
                return { status, checks };

            } catch (error) {
                console.log = originalLog;
                
                testDiv.innerHTML = `
                    <h3>${testCase.name}</h3>
                    <div class="input">üìù Input: ${testCase.input}</div>
                    <div class="result fail">
                        <strong>‚ùå ERROR</strong>
                        <div class="detail">${error.message}</div>
                    </div>
                    <div class="console-log">
                        <pre>${logs.join('\n')}</pre>
                    </div>
                `;
                
                resultsDiv.appendChild(testDiv);
                return { status: 'fail', error };
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üöÄ Auto-running tests...');
                runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>
