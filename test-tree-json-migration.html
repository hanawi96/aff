<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test tree.json Migration</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #3c3c3c;
            border-radius: 5px;
            background: #252526;
        }
        .test-section.pass {
            border-color: #4ec9b0;
            background: #1e3a32;
        }
        .test-section.fail {
            border-color: #f48771;
            background: #3a1e1e;
        }
        h1 {
            color: #4ec9b0;
        }
        h2 {
            color: #dcdcaa;
            margin-top: 30px;
        }
        h3 {
            color: #569cd6;
        }
        .pass { color: #4ec9b0; }
        .fail { color: #f48771; }
        .info { color: #9cdcfe; }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
    </style>
</head>
<body>
    <h1>üß™ Test tree.json Migration</h1>
    
    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="location.reload()">üîÑ Reload</button>
    
    <div id="test-results"></div>

    <script src="/assets/js/address-selector.js"></script>
    <script>
        async function runAllTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p class="info">‚è≥ Running tests...</p>';
            
            const results = [];
            
            // Test 1: Load data
            results.push(await testLoadData());
            
            // Test 2: Data structure
            results.push(await testDataStructure());
            
            // Test 3: B√¨nh D∆∞∆°ng districts
            results.push(await testBinhDuongDistricts());
            
            // Test 4: B·∫Øc T√¢n Uy√™n wards
            results.push(await testBacTanUyenWards());
            
            // Test 5: T√¢n Uy√™n upgrade
            results.push(await testTanUyenUpgrade());
            
            // Test 6: Lookup performance
            results.push(await testLookupPerformance());
            
            // Render results
            renderResults(results);
        }
        
        async function testLoadData() {
            const test = {
                name: 'Test 1: Load tree.json',
                passed: false,
                message: '',
                details: ''
            };
            
            try {
                await window.addressSelector.init();
                
                const provinceCount = window.addressSelector.data.length;
                const districtCount = window.addressSelector.districtMap.size;
                const wardCount = window.addressSelector.wardMap.size;
                
                test.details = `
Provinces: ${provinceCount}
Districts: ${districtCount}
Wards: ${wardCount}
                `.trim();
                
                if (provinceCount === 63 && districtCount > 700 && wardCount > 10000) {
                    test.passed = true;
                    test.message = '‚úÖ Data loaded successfully';
                } else {
                    test.message = '‚ùå Data counts unexpected';
                }
            } catch (error) {
                test.message = `‚ùå Error: ${error.message}`;
                test.details = error.stack;
            }
            
            return test;
        }
        
        async function testDataStructure() {
            const test = {
                name: 'Test 2: Data structure compatibility',
                passed: false,
                message: '',
                details: ''
            };
            
            try {
                const province = window.addressSelector.data[0];
                const hasId = 'Id' in province;
                const hasName = 'Name' in province;
                const hasDistricts = 'Districts' in province;
                
                const district = province.Districts[0];
                const districtHasId = 'Id' in district;
                const districtHasName = 'Name' in district;
                const districtHasWards = 'Wards' in district;
                
                const ward = district.Wards[0];
                const wardHasId = 'Id' in ward;
                const wardHasName = 'Name' in ward;
                
                test.details = `
Province structure:
  - Id: ${hasId ? '‚úÖ' : '‚ùå'}
  - Name: ${hasName ? '‚úÖ' : '‚ùå'}
  - Districts: ${hasDistricts ? '‚úÖ' : '‚ùå'}

District structure:
  - Id: ${districtHasId ? '‚úÖ' : '‚ùå'}
  - Name: ${districtHasName ? '‚úÖ' : '‚ùå'}
  - Wards: ${districtHasWards ? '‚úÖ' : '‚ùå'}

Ward structure:
  - Id: ${wardHasId ? '‚úÖ' : '‚ùå'}
  - Name: ${wardHasName ? '‚úÖ' : '‚ùå'}
                `.trim();
                
                if (hasId && hasName && hasDistricts && 
                    districtHasId && districtHasName && districtHasWards &&
                    wardHasId && wardHasName) {
                    test.passed = true;
                    test.message = '‚úÖ Data structure is backward compatible';
                } else {
                    test.message = '‚ùå Data structure incompatible';
                }
            } catch (error) {
                test.message = `‚ùå Error: ${error.message}`;
                test.details = error.stack;
            }
            
            return test;
        }
        
        async function testBinhDuongDistricts() {
            const test = {
                name: 'Test 3: B√¨nh D∆∞∆°ng districts',
                passed: false,
                message: '',
                details: ''
            };
            
            try {
                const bd = window.addressSelector.data.find(p => p.Name.includes('B√¨nh D∆∞∆°ng'));
                
                if (!bd) {
                    test.message = '‚ùå B√¨nh D∆∞∆°ng not found';
                    return test;
                }
                
                const districtNames = bd.Districts.map(d => d.Name);
                const hasBacTanUyen = districtNames.some(n => n.includes('B·∫Øc T√¢n Uy√™n'));
                const hasTanUyen = districtNames.some(n => n === 'Th√†nh ph·ªë T√¢n Uy√™n');
                
                test.details = `
B√¨nh D∆∞∆°ng districts (${bd.Districts.length}):
${districtNames.map(n => `  - ${n}`).join('\n')}

Key checks:
  - Huy·ªán B·∫Øc T√¢n Uy√™n: ${hasBacTanUyen ? '‚úÖ' : '‚ùå'}
  - Th√†nh ph·ªë T√¢n Uy√™n: ${hasTanUyen ? '‚úÖ' : '‚ùå'}
                `.trim();
                
                if (hasBacTanUyen && hasTanUyen) {
                    test.passed = true;
                    test.message = '‚úÖ B√¨nh D∆∞∆°ng districts correct';
                } else {
                    test.message = '‚ùå Missing expected districts';
                }
            } catch (error) {
                test.message = `‚ùå Error: ${error.message}`;
                test.details = error.stack;
            }
            
            return test;
        }
        
        async function testBacTanUyenWards() {
            const test = {
                name: 'Test 4: B·∫Øc T√¢n Uy√™n wards',
                passed: false,
                message: '',
                details: ''
            };
            
            try {
                const bd = window.addressSelector.data.find(p => p.Name.includes('B√¨nh D∆∞∆°ng'));
                const btu = bd.Districts.find(d => d.Name.includes('B·∫Øc T√¢n Uy√™n'));
                
                if (!btu) {
                    test.message = '‚ùå B·∫Øc T√¢n Uy√™n not found';
                    return test;
                }
                
                const wardNames = btu.Wards.map(w => w.Name);
                const hasTanLap = wardNames.some(n => n.includes('T√¢n L·∫≠p'));
                
                test.details = `
Huy·ªán B·∫Øc T√¢n Uy√™n wards (${btu.Wards.length}):
${wardNames.map(n => `  - ${n}`).join('\n')}

Key check:
  - X√£ T√¢n L·∫≠p: ${hasTanLap ? '‚úÖ' : '‚ùå'}
                `.trim();
                
                if (hasTanLap && btu.Wards.length >= 10) {
                    test.passed = true;
                    test.message = '‚úÖ B·∫Øc T√¢n Uy√™n wards correct';
                } else {
                    test.message = '‚ùå Missing X√£ T√¢n L·∫≠p';
                }
            } catch (error) {
                test.message = `‚ùå Error: ${error.message}`;
                test.details = error.stack;
            }
            
            return test;
        }
        
        async function testTanUyenUpgrade() {
            const test = {
                name: 'Test 5: T√¢n Uy√™n upgrade (Th·ªã x√£ ‚Üí Th√†nh ph·ªë)',
                passed: false,
                message: '',
                details: ''
            };
            
            try {
                const bd = window.addressSelector.data.find(p => p.Name.includes('B√¨nh D∆∞∆°ng'));
                const tanUyen = bd.Districts.find(d => d.Name === 'Th√†nh ph·ªë T√¢n Uy√™n');
                const oldTanUyen = bd.Districts.find(d => d.Name === 'Th·ªã x√£ T√¢n Uy√™n');
                
                test.details = `
T√¢n Uy√™n status:
  - Th√†nh ph·ªë T√¢n Uy√™n: ${tanUyen ? '‚úÖ Found' : '‚ùå Not found'}
  - Th·ªã x√£ T√¢n Uy√™n: ${oldTanUyen ? '‚ùå Still exists (should be upgraded)' : '‚úÖ Not found (correct)'}
                `.trim();
                
                if (tanUyen && !oldTanUyen) {
                    test.passed = true;
                    test.message = '‚úÖ T√¢n Uy√™n correctly upgraded to Th√†nh ph·ªë';
                } else {
                    test.message = '‚ùå T√¢n Uy√™n upgrade status incorrect';
                }
            } catch (error) {
                test.message = `‚ùå Error: ${error.message}`;
                test.details = error.stack;
            }
            
            return test;
        }
        
        async function testLookupPerformance() {
            const test = {
                name: 'Test 6: Lookup performance (O(1))',
                passed: false,
                message: '',
                details: ''
            };
            
            try {
                const iterations = 10000;
                
                // Test province lookup
                const provinceStart = performance.now();
                for (let i = 0; i < iterations; i++) {
                    window.addressSelector.getProvinceName('74');
                }
                const provinceTime = performance.now() - provinceStart;
                
                // Test district lookup
                const districtStart = performance.now();
                for (let i = 0; i < iterations; i++) {
                    window.addressSelector.getDistrictName('74', '723');
                }
                const districtTime = performance.now() - districtStart;
                
                // Test ward lookup
                const wardStart = performance.now();
                for (let i = 0; i < iterations; i++) {
                    window.addressSelector.getWardName('74', '723', '25924');
                }
                const wardTime = performance.now() - wardStart;
                
                const avgProvince = (provinceTime / iterations).toFixed(4);
                const avgDistrict = (districtTime / iterations).toFixed(4);
                const avgWard = (wardTime / iterations).toFixed(4);
                
                test.details = `
Performance (${iterations} iterations):
  - Province lookup: ${provinceTime.toFixed(2)}ms (avg: ${avgProvince}ms)
  - District lookup: ${districtTime.toFixed(2)}ms (avg: ${avgDistrict}ms)
  - Ward lookup: ${wardTime.toFixed(2)}ms (avg: ${avgWard}ms)
                `.trim();
                
                // Should be very fast (< 1ms total for 10k iterations)
                if (provinceTime < 100 && districtTime < 100 && wardTime < 100) {
                    test.passed = true;
                    test.message = '‚úÖ Lookup performance excellent (O(1))';
                } else {
                    test.message = '‚ö†Ô∏è Lookup performance acceptable but could be better';
                    test.passed = true; // Still pass, just slower
                }
            } catch (error) {
                test.message = `‚ùå Error: ${error.message}`;
                test.details = error.stack;
            }
            
            return test;
        }
        
        function renderResults(results) {
            const resultsDiv = document.getElementById('test-results');
            
            const passCount = results.filter(r => r.passed).length;
            const failCount = results.length - passCount;
            
            let html = `
                <h2>üìä Test Results</h2>
                <p>
                    <span class="pass">‚úÖ Passed: ${passCount}</span> | 
                    <span class="fail">‚ùå Failed: ${failCount}</span> | 
                    <span class="info">Total: ${results.length}</span>
                </p>
            `;
            
            results.forEach(result => {
                html += `
                    <div class="test-section ${result.passed ? 'pass' : 'fail'}">
                        <h3>${result.name}</h3>
                        <p class="${result.passed ? 'pass' : 'fail'}">${result.message}</p>
                        <pre>${result.details}</pre>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
