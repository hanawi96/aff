<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test Reverse Lookup</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .test { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .input { color: #1976D2; font-weight: bold; }
        .result { color: #388E3C; margin: 10px 0; }
        .error { color: #D32F2F; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üß™ Test Reverse Lookup (Ward ‚Üí District ‚Üí Province)</h1>
    
    <div class="test">
        <h3>Test Case 1: Ch·ªâ c√≥ th√¥n + x√£</h3>
        <div class="input">Input: "th√¥n H·∫≠u D∆∞∆°ng, X√£ Kim Chung"</div>
        <button onclick="test1()">Test</button>
        <div id="result1"></div>
    </div>
    
    <div class="test">
        <h3>Test Case 2: Ch·ªâ c√≥ x√≥m + x√£</h3>
        <div class="input">Input: "x√≥m 4, X√£ Tr√°ng Vi·ªát"</div>
        <button onclick="test2()">Test</button>
        <div id="result2"></div>
    </div>
    
    <div class="test">
        <h3>Test Case 3: Ch·ªâ c√≥ x√£ (kh√¥ng c√≥ th√¥n/x√≥m)</h3>
        <div class="input">Input: "X√£ Kim Chung"</div>
        <button onclick="test3()">Test</button>
        <div id="result3"></div>
    </div>

    <script>
        // Load address data
        let addressData = [];
        
        async function loadAddressData() {
            const response = await fetch('/public/assets/data/vietnamAddress.json');
            addressData = await response.json();
            console.log('Loaded', addressData.length, 'provinces');
        }
        
        loadAddressData();
        
        function removeVietnameseTones(str) {
            if (!str) return '';
            return str
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒë/g, 'd')
                .trim();
        }
        
        function fuzzyMatch(input, options, threshold = 0.6) {
            const normalizedInput = removeVietnameseTones(input);
            const cleanInput = normalizedInput
                .replace(/^(tinh|thanh pho|tp|quan|huyen|phuong|xa|thi tran|tt|thi xa|tx)\s+/i, '')
                .toLowerCase()
                .trim();
            
            let bestMatch = null;
            let bestScore = 0;
            
            for (const option of options) {
                const normalizedOption = removeVietnameseTones(option.Name);
                const cleanOption = normalizedOption
                    .replace(/^(tinh|thanh pho|tp|quan|huyen|phuong|xa|thi tran|tt|thi xa|tx)\s+/i, '')
                    .toLowerCase()
                    .trim();
                
                let score = 0;
                
                if (normalizedOption === normalizedInput || cleanOption === cleanInput) {
                    return { match: option, score: 1.0 };
                }
                
                if (normalizedInput.includes(cleanOption) && cleanOption.length >= 4) {
                    score = 0.9;
                } else if (cleanOption.includes(cleanInput) && cleanInput.length >= 4) {
                    score = 0.85;
                }
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = option;
                }
            }
            
            if (bestScore >= threshold) {
                return { match: bestMatch, score: bestScore };
            }
            
            return null;
        }
        
        function reverseWardLookup(addressText) {
            const parts = addressText.split(',').map(p => p.trim());
            const wardKeywords = ['phuong', 'xa', 'thi tran', 'tt', 'khom'];
            
            let bestWardMatch = null;
            let bestWardScore = 0;
            let wardParentDistrict = null;
            let wardParentProvince = null;
            
            for (const part of parts) {
                const normalized = removeVietnameseTones(part).toLowerCase();
                const hasWardKeyword = wardKeywords.some(kw => normalized.includes(kw));
                
                if (hasWardKeyword && part.length >= 4) {
                    console.log('Checking ward part:', part);
                    
                    for (const province of addressData) {
                        for (const district of province.Districts) {
                            const wardMatch = fuzzyMatch(part, district.Wards, 0.6);
                            if (wardMatch && wardMatch.score > bestWardScore) {
                                bestWardScore = wardMatch.score;
                                bestWardMatch = wardMatch.match;
                                wardParentDistrict = district;
                                wardParentProvince = province;
                                console.log('Found:', wardMatch.match.Name, 'in', district.Name, province.Name, 'score:', wardMatch.score);
                            }
                        }
                    }
                }
            }
            
            if (bestWardMatch && bestWardScore >= 0.7) {
                return {
                    success: true,
                    ward: bestWardMatch.Name,
                    district: wardParentDistrict.Name,
                    province: wardParentProvince.Name,
                    score: bestWardScore
                };
            }
            
            return { success: false };
        }
        
        function test1() {
            const result = reverseWardLookup("th√¥n H·∫≠u D∆∞∆°ng, X√£ Kim Chung");
            const html = result.success ? 
                `<div class="result">‚úÖ Found!<br>Ward: ${result.ward}<br>District: ${result.district}<br>Province: ${result.province}<br>Score: ${result.score.toFixed(2)}</div>` :
                `<div class="error">‚ùå Not found</div>`;
            document.getElementById('result1').innerHTML = html;
        }
        
        function test2() {
            const result = reverseWardLookup("x√≥m 4, X√£ Tr√°ng Vi·ªát");
            const html = result.success ? 
                `<div class="result">‚úÖ Found!<br>Ward: ${result.ward}<br>District: ${result.district}<br>Province: ${result.province}<br>Score: ${result.score.toFixed(2)}</div>` :
                `<div class="error">‚ùå Not found</div>`;
            document.getElementById('result2').innerHTML = html;
        }
        
        function test3() {
            const result = reverseWardLookup("X√£ Kim Chung");
            const html = result.success ? 
                `<div class="result">‚úÖ Found!<br>Ward: ${result.ward}<br>District: ${result.district}<br>Province: ${result.province}<br>Score: ${result.score.toFixed(2)}</div>` :
                `<div class="error">‚ùå Not found</div>`;
            document.getElementById('result3').innerHTML = html;
        }
    </script>
</body>
</html>
